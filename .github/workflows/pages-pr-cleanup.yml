name: Cleanup PR Pages Preview

on:
  pull_request:
    types:
      - closed

permissions:
  contents: write
  deployments: write

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Remove PR preview directory from gh-pages
        id: cleanup
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          PR_DIR="pr-${{ github.event.pull_request.number }}"
          REPO_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          TMP_DIR="$(mktemp -d)"

          if ! git clone --depth 1 --branch gh-pages "${REPO_URL}" "${TMP_DIR}"; then
            echo "removed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ ! -d "${TMP_DIR}/${PR_DIR}" ]; then
            echo "removed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          rm -rf "${TMP_DIR:?}/${PR_DIR}"

          git -C "${TMP_DIR}" config user.name "github-actions[bot]"
          git -C "${TMP_DIR}" config user.email "github-actions[bot]@users.noreply.github.com"
          git -C "${TMP_DIR}" add -A

          if git -C "${TMP_DIR}" diff --cached --quiet; then
            echo "removed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git -C "${TMP_DIR}" commit -m "chore: remove PR preview ${PR_DIR}"
          git -C "${TMP_DIR}" push origin gh-pages
          echo "removed=true" >> "$GITHUB_OUTPUT"

      - name: Mark PR environment inactive
        if: steps.cleanup.outputs.removed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const environmentName = `pr-${{ github.event.pull_request.number }}`;
            const deployments = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              environment: environmentName,
              per_page: 1
            });

            if (!deployments.data.length) {
              core.info(`No deployments found for ${environmentName}`);
              return;
            }

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployments.data[0].id,
              state: "inactive",
              environment: environmentName,
              log_url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            });
